<div class="page page-list">
    <img class="change-news" src="images/icon-new.png" id="add-new-rent"/>
    <div class="weui-search-bar" id="searchBar">
        <form class="weui-search-bar__form">
            <div class="weui-search-bar__box">
                <i class="weui-icon-search"></i>
                <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="请输入搜索地址" required="">
                <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
            </div>
        </form>
    </div>
    <div class="weui-search-bar active" id="cardBar">
        <form class="weui-search-bar__form">
            <div class="weui-search-bar__box">
                <i class="weui-icon-search"></i>
                <input type="search" class="weui-search-bar__input" id="cardInput" placeholder="请输入搜索身份证号码" required="">
                <a href="javascript:" class="weui-icon-clear" id="cardClear"></a>
            </div>
        </form>
        <a href="javascript:" class="weui-search-bar__cancel-btn" id="cardCancel">取消</a>
    </div>
    <div class="weui-tab">
        <div class="weui-navbar">
            <div class="weui-navbar__item weui-bar__item_on" href="#tab1" data-state="0" data-url="api/floor/list.json">租住房屋<span id="number-left"></span></div>
            <div class="weui-navbar__item" href="#tab2" data-state="1" data-url="api/employee.json">租住人数<span id="number-right"></span></div>
        </div>
    </div>
    <div class="page__bd cell-y bg-page bottom-cell">
        <div id="box" class="bg-box">
            <div class="weui-tab__panel panel_none">
                <div class="weui-cells"  id="tab1" ></div>
                <div class="weui-cells active"  id="tab2"></div>
            </div>
            <div class="weui-loadmore" id="load">
                <i class="weui-loading"></i>
                <span class="weui-loadmore__tips">正在加载</span>
            </div>
            <div class="weui-loadmore weui-loadmore_line active">
                <span class="weui-loadmore__tips">暂无更多数据</span>
            </div>
        </div>
    </div>
    <div class="pop-add-box" id="pop-add-box">
        <div class="rent-pop" id="add"></div>
        <input type="button" value="新建房屋" class="add-rent-button" data-id="rent-add" id="rent-add"/>
        <input type="button" value="选择已有房屋" class="already-have-rent"  data-id="add-have-rent" id="add-have-rent"/>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var $container = $('#container');
        var $searchClear = $('#searchClear');
        var $searchInput = $('#searchInput');
        var $cardClear = $('#cardClear');
        var $cardInput = $('#cardInput');
        var currState = '0';
        var container = $('#container');
        var pagePanel = container.find('.page .page__bd');
        var url='api/floor/list.json';
        var currDataListCfg = {
            url:url,
            pagePanel:pagePanel,
            scrollPanel:pagePanel.find('#box'),
            xhrListKey:'',
            winPanel:container,
            xhrExternalProcess : function (params,xhr) {
                var data = xhr;
                $('.res-joint').click(function(){
                    $container.data('data-floorid',$(this).attr('id'));
                    $container.data('data-floor-place',$(this).find('.head-name').html());
                    var id = $(this).data('id');
                    window.pageManager.go(id);
                });
                var tag = currState=='0';
                if(tag){
                    $('#searchBar').show();
                    $('#cardBar').hide();
                }else{
                    cardList();
                    $('#searchBar').hide();
                    $('#cardBar').show();
                }
            },
            emptyCb : function () {
                var tag = currState=='0';
                var tabPanel = tag?'tab1':'tab2';
                var img = tag?'icon-ok.jpg':'icon-over.jpg';
                var txt = tag?'对不起！':'对不起！';
                var txt1 = tag?'暂无租住房屋信息':'暂无租住人员信息';
                $('#'+tabPanel).html('<div class="empty-box">'+
                        '<img src="images/'+img+'" class="empty-img"/>'+
                        '<p class="null-word">'+txt+'</p>'+
                        '<p class="null-word2">'+txt1+'</p>'+
                        '</div>');
            },
            noMoreCb : function () {
                $('.weui-loadmore_line').show();
                $('.empty-box').hide();
            },
            getItemsPanel : function () {
                return $('#tab1')
            },
            templateProcess : function (item) {
                var tag = currState=='0';
                var html;
                var ridg = item.ridgepole+'栋'
                var units = item.unit+'单元'
                if(item.ridgepole==null||item.ridgepole.length==0){
                    ridg = '';
                }
                if(item.unit==null||item.unit.length==0){
                    units = '';
                }
                var place = item.street+item.num+'号'+ridg+units+item.door+'门'
                var renterNum = item.tenants.length;
                if(tag){
                    html = ' <div class="joint-border res-joint" data-id="renter-news" id="'+item.id+'">' +
                            '<div><img src="images/list-left.jpg" class="border-right-img"/></div>'+
                            '<div class="head-name ellipsis">'+place+'</div>'+
                            '<div class="building-num">'+renterNum+'人</div>'+
                            '</div>'
                }
                return html;
            },
            before:function(){
                $("#load").show();
                $(".weui-loadmore_line").hide();
            },
            after:function(){
                $("#load").hide();
            }
        };
        var currDataList = window.dataList.newList(currDataListCfg);
        $('.weui-navbar__item').on('click', function () {
            $(this).addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
        });
        $(".weui-navbar div").click(function() {
            var state = $(this).data('state');
            var urls = $(this).data('url');
            if(state != currState){
                $('#container').data('detail-source-state',state);
                var activeTab = $(this).attr("href");
                $(".weui-cells").hide();
                $(activeTab).html('').fadeIn();
                currState = state;
                url = urls;
                currDataList.first({state:state});
            }
            return false;
        });
        function cardList(cardval){
            $.ajax({
                type: "POST",
                url: "api/tenant/list.json",
                data: {userid: $('#userid').val(),sfzh:cardval},
                success: function (data) {
                    for(var i=0;i<data.length;i++){
                        $('#tab2').append(
                                '<div class="weui-cell bg-cell" id="'+data[i].id+'"  data-id="rent-detail">' +
                                '<div class="weui-cell__bd cell_bd_border" >' +
                                '<div><img src="images/list-left.jpg" class="border-right-img"/></div>'+
                                '<p class="left-cell">' +
                                data[i].sfzh +
                                '</p>' +
                                '<div class="weui-cell__ft cell_fs left-cell">' +
                                '<img src="images/icon-time.jpg" class="position-time"/>'+
                                '<span>'+getLocalTime(data[i].date)+'</span>'  +
                                '</div>' +
                                '</div>' +
                                '</div>'
                        )
                    }
                    $(".weui-cell").on('click',function () {
                        var id = $(this).data('id');
                        var rid = $(this).attr('id');
                        $container.data('data-renter-id',rid)
                        window.pageManager.go(id);
                    });
                },
                error: function (mes) {
                    console.log("error");
                }
            });
        }
        fCount();
        tCount();
        function fCount(condition){
            $.ajax({
                type: "POST",
                url: "api/floor/count.json",
                data: {userid: $('#userid').val(),condition:condition},
                success: function (data) {
                    if(data.count==null){
                        data.count=0;
                    }
                    $('#number-left').html('('+data.count+')');
                },
                error: function (mes) {
                }
            });
        }
        function tCount(sfzh){
            $.ajax({
                type: "POST",
                url: "api/tenant/count.json",
                data: {userid: $('#userid').val(),sfzh:sfzh},
                success: function (data) {
                    if(data.count==null){
                        data.count=0;
                    }
                    $('#number-right').html('('+data.count+')');
                },
                error: function (mes) {
                }
            });
        }

        var detailSourceState = container.data('detail-source-state');
        if(detailSourceState && detailSourceState != currState){
            currState = detailSourceState;
            var target = $('.weui-navbar [data-state="1"]');
            target.addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
            cardList();
            $(target.attr("href")).fadeIn();
        }
        currDataList.first({});
        $('#clear').on('click',function () {
            $('#filtrate').fadeOut(100);
        });
        $('#add').on('click',function(){
            $('#pop-add-box').fadeOut(100);
        });
        $searchClear.on('click',function(){
            $searchInput.val('');
            currDataList.first({condition:''});
            fCount('');
        });
        $cardClear.on('click',function(){
            $cardInput.val('');
            cardList('');
            tCount('');
        });
        $('#add-have-rent,#rent-add').click(function(){
            var id = $(this).data('id');
            window.pageManager.go(id);
            $container.data('data-floorid','');
        });
        //搜索地址
        var search = function(){
            var val=$searchInput.val();
            container.data('data-list-val',val);
            if(val != ""){
                currDataList.first({condition:val});
                fCount(val);
            }else{
                currDataList.first({condition:''});
                fCount('');
            }
        };
        $searchInput.on('keyup',function(){
            window.lazyRateProxy(search,500);
        });
        //搜索身份证号码
        var cardsearch = function(){
            var cardval=$cardInput.val();
            container.data('data-list-cardval',cardval);
            if(cardval != ""){
                cardList(cardval);
                tCount(cardval);
            }else{
                cardList('');
                tCount('');
            }
        };
        $cardInput.on('keyup',function(){
            window.lazyRateProxy(cardsearch ,500);
        });
        //拖拽
        function alertPop(id,tid){
            $(id).on('mousedown',function(e){
                var _event = window.event||e;
                var left = _event.offsetX;
                var top = _event.offsetY;
                var downX = _event.pageX;
                var downY = _event.pageY;
                _event.preventDefault();
                $('body').on('mousemove',function(e){
                    var _event = window.event||e;
                    var x = _event.clientX-left;
                    var y = _event.clientY-top;
                    $(id).css('left',x + "px");
                    $(id).css('top',y + "px");
                });
                $(id).on('mouseup',function(e){
                    $('body').unbind();
                    var upX = e.pageX;
                    var upY = e.pageY;
                    var moveX = downX - upX;
                    var moveY = downY - upY;
                    if(moveX==0&&moveY==0){
                        $searchInput.val('');
                        $(tid).fadeIn(100);
                    }
                });
            });
            $(id).on('touchstart',function(e){
                var left = e.touches[0].pageX;
                var top = e.touches[0].pageY;
                e.preventDefault();
                $('body').on('touchmove',function(e){
                    var x = e.touches[0].clientX-25;
                    var y = e.touches[0].clientY-25;
                    $(id).css('left',x + "px");
                    $(id).css('top',y + "px");
                });
                $(id).on('touchend',function(e){
                    var endX = e.changedTouches[0].pageX;
                    var endY= e.changedTouches[0].pageY;
                    var moveX = left - endX;
                    var moveY = top -endY;
                    $('body').unbind();
                    if(moveX<5&&moveX>-5&&moveY<5&&moveY>-5){
                        $searchInput.val('');
                        $(tid).fadeIn(100);
                    }
                });
            });
        }
        alertPop('#add-new-rent','#pop-add-box,#add');
        alertPop('#choice-alert','#filtrate');
    });
</script>
