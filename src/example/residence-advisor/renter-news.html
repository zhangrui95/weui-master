<div class="page">
    <div class="nocard-title">
        <div class="fire-header-left" id="rent-place-header"></div>
        <div class="right-title" id="number-right"></div>
    </div>
    <div id="idCard-list"></div>
    <div class="add-line" id="add-renter"><span class="add">+</span>新增租住人员信息</div>
    <div class="js_dialog" id="androidDialog2" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog weui-skin_android">
            <div class="weui-dialog__bd" id="dialog"></div>
            <div class="weui-dialog__ft" id="primary-box">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default" id="default">取消</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="primary">确定</a>
            </div>
        </div>
    </div>
    <div class="page-alert active" id="personbackground">
        <div class="page__bd page_y">
            <div id="error" class="error" style="display: none;">
                <img src="images/error.png"/>
                <span>当前网络不可用，请检查你的网络设置</span>
            </div>
            <div class="weui-cells weui-cells_form" style="margin-top: 0;">
                <div class="weui-cell">
                    <div class="weui-cell__bd cell-unleft">
                        <div class="weui-uploader">
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="uploaderFiles">
                                </ul>
                                <div class="weui-uploader__input-box file-img">
                                    <input id="uploaderInput" class="weui-uploader__input" type="button" />
                                    <p class="change-img">拍摄租客照片</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="detail">
                <div class="none-flex cell-border">
                    <div class="weui-cell__hd"><label class="weui-label">身份证号</label></div>
                    <div class="weui-cell__bd bd-right">
                        <input id="card" class="weui-input input-text-right" type="text" placeholder="租客身份证号"/>
                    </div>
                    <div class="red-star">*</div>
                </div>
                <div class="none-flex cell-border">
                    <div class="weui-cell__hd"><label class="weui-label">手机号码</label></div>
                    <div class="weui-cell__bd bd-right">
                        <input id="phone" class="weui-input input-text-right" type="text" placeholder="租客11位手机号码"/>
                    </div>
                </div>
            </div>
            <div class="prompt active" id="idCard"></div>
            <div class="weui-gallery" id="gallery">
                <span class="weui-gallery__img" id="galleryImg"></span>
                <div class="weui-gallery__opr">
                    <a href="javascript:" class="weui-gallery__del">
                        <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="btn-box" data-id="employee_list">
            <div class="btn-box button-box">
                <a class="btn" href="javascript:" id="showToast" data-id="renter-news">保存</a>
            </div>
        </div>
    </div>
</div>
<script>
    $(function(){
        var $container = $('#container');
        var floorId = $container.data('data-floorid');
        var place =$container.data('data-floor-place');
        $('#rent-place-header').html(place);
        //身份证列表
        idCardList();
        function idCardList() {
            $.ajax({
                type: "POST",
                url: "api/tenant/list.json",
                data:{userid:$('#userid').val(),floorid:floorId},
                success: function (data) {
                    list(data);
                },
                error: function (mes) {
                    $('#error').css("display","block");
                }
            });
        }
        function list(data) {
            $('#number-right').html(data.length+'人')
            $('#idCard-list').html('');
            for(var i = 0;i<data.length;i++){
                $('#idCard-list').append(
                        '<div class="position-del-box">'+
                            '<div class="none-flex cell-border cell-margin" data-rentid="'+data[i].id+'" data-id="rent-detail">'+
                                '<div class="weui-cell__hd card-val">'+data[i].sfzh+'</div>'+
                            '</div>'+
                            '<div class="link-delete block dele-word" data-del="'+data[i].id+'">注销</div>'+
                        '</div>'
                );
            }
            del();
            $('.cell-margin').click(function(){
                var rid = $(this).data('rentid')
                $container.data('data-renter-id',rid)
                var id = $(this).data('id');
                window.pageManager.go(id);
            });
        }
        $('#add-renter').on('click',function(){
            inPop(function(){
                $('#personbackground').hide();
            });
            $('#personbackground').show();
        });
        function del(){
            $('.dele-word').bind('click',function(){
                var _this = $(this);
                $('#androidDialog2').fadeIn(100);
                $('#dialog').html('确定注销该租住人员信息？');
                $('#default').on('click',function(){
                    $('#androidDialog2').fadeOut(100);
                });
                $('#primary').on('click',function(){
                    $('#androidDialog2').fadeOut(100);
                    _this.parent().remove();
                    var delId = _this.data('del');
                    console.log(delId)
                    $.ajax({
                        type: "POST",
                        url: "api/tenant/cancel.json",
                        data:{userid:$('#userid').val(),id:delId},
                        success: function (data) {
                            idCardList();
                        },
                        error: function (mes) {
                            console.log('error');
                        }
                    });
                });
            });
        }
        function inPop(callback){
            pageManager.setBeforeHashchangeOnce(function (e) {
                callback()
                return false;
            })
        }
        function outPop(){
            pageManager.setBeforeHashchangeOnce(null)
        }
        //弹出添加新人员信息
        var tmpl = '<li class="weui-uploader__file head-image" style="background-image:url(#url#)"></li>',
                $gallery = $("#gallery"), $galleryImg = $("#galleryImg"),
                $uploaderInput = $("#uploaderInput"),
                $uploaderFiles = $("#uploaderFiles"),
                localId,
                tag = false
                ;
        $uploaderInput.on("click", function(e){
            wx.chooseImage({
                count: 1, // 默认9
                sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                success: function (res) {
                    var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                    localId = localIds[0];
                    $uploaderFiles.append($(tmpl.replace('#url#', localId)));
                    $(".weui-uploader__input-box").css("display","none");
                    $('.weui-gallery__opr').click(function () {
                        $uploaderFiles.html('');
                        localId = '';
                        $(".weui-uploader__input-box").css("display","block");
                    })
                },
                fail:function(err){
                    $('#idCard').html("选择照片失败！");
                    $('#idCard').fadeIn(100);
                    setTimeout(function () {
                        $('#idCard').fadeOut(100);
                    }, 2000);
                }
            });
        });
        function inPop(callback){
            pageManager.setBeforeHashchangeOnce(function (e) {
                callback();
                return false;
            })
        }

        function outPop(){
            pageManager.setBeforeHashchangeOnce(null)
        }
        $uploaderFiles.on("click", "li", function(){
            inPop(function(){
                $gallery.fadeOut(100);
            });
            $galleryImg.attr("style", this.getAttribute("style"));
            $gallery.fadeIn(100);
        });
        $gallery.on("click", function(){
            outPop();
            $gallery.fadeOut(100);
        });
        var cardValid = function (value) {
            var ex = /^((1[1-5])|(2[1-3])|(3[1-7])|(4[1-6])|(5[0-4])|(6[1-5])|71|(8[12])|91)\d{4}(19|2[0-9])((\d{2}(0[13-9]|1[012])(0[1-9]|[12]\d|30))|(\d{2}(0[13578]|1[02])31)|(\d{2}02(0[1-9]|1\d|2[0-8]))|(([13579][26]|[2468][048]|0[48])0229))\d{3}(\d|X|x)?$/;
            var pattern = new RegExp(ex);
            if(!pattern.test(value)){
                return false;
            }
            var params = [ 7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2 ];
            var checks = [ 1, 0, 10, 9, 8, 7, 6, 5, 4, 3, 2 ];
            var id=value;
            var sum = 0;
            for (var i = 0; i < 17; i++) {
                var tmp = id.charAt(i);
                sum += params[i] * tmp;
            }
            sum %= 11;
            var check;
            if (id.charAt(17) == 'x' || id.charAt(17) == 'X') {
                check = 10;
            } else {
                check = id.charAt(17);
            }
            return check == checks[sum];
        };
        $('#card').blur(function () {
            $('#empty').css('display', 'none');
            var value=$('#card').val();
            if (value == '') {
                $('#idCard').html("身份证号码不能为空");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
            } else if(!cardValid(value)){
                $('#idCard').html("无效的身份证号码");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
                $('#empty').css('display', 'block');
                return ;
            }
        });
        $('#card').keyup(function(){
            if(($('#card').val()+"").length>=1){
                $('#empty').css('display', 'block');
                $('#empty').click(function () {
                    $('#card').val('');
                    $('#empty').css('display', 'none');
                })
            }else {
                $('#empty').css('display', 'none');
            }
        });
        $('#showToast').on('click',function(){
            if(localId==null||localId==''){
                $('#idCard').html("照片不能为空");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
                return;
            }
            var phone = /^1[34578]\d{9}$/;
            var phonenum = $('#phone').val();
            if(phonenum != ''&&phone.test(phonenum)==false){
                $('#idCard').html("手机号码不正确");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
            }
            var value=$('#card').val();
            if (value == '') {
                $('#idCard').html("身份证号码不能为空");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
                return ;
            } else if(!cardValid(value)){
                $('#idCard').html("无效的身份证号码");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
                $('#empty').css('display', 'block');
                return ;
            }
            if(tag){
                return;
            }
            tag = true;
            $('#card').blur();
            wx.uploadImage({
                localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
                isShowProgressTips: 1,// 默认为1，显示进度提示
                success: function (res) {
                    var serverId = res.serverId; // 返回图片的服务器端ID
                    idCard($('#card').val(),serverId,$('#phone').val());
                },
                fail:function(err){
                    $('#error').css("display","block");
                    tag = false;
                }
            });
        });
        function idCard(value,serverId,phone){
            $('#empty').css('display','none');
            $.ajax({
                type: "POST",
                url: "api/tenant/save.json",
                async: true,
                data:{sfzh:value,userid:$('#userid').val(),serverId:serverId,floorid:floorId,phone:phone},
                success: function (card) {
                    $('#personbackground').hide();
                    idCardList();
                },
                error: function () {
                    $('#error').css("display","block");
                    tag = false;
                }
            });
        }
    });
</script>