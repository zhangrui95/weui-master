<div class="page page-list">
    <img class="change-news" src="images/icon-edit.png" id="change"/>
    <div id="error" class="error" style="display: none;">
        <img src="images/error.png"/>
        <span>当前网络不可用，请检查你的网络设置</span>
    </div>
    <form class="active" id="form-box"></form>
    <div class="page__bd details cells-ajax page_y"></div>
    <div class="weui-gallery" id="gallery">
        <img  class="weui-gallery__img center-img" id="galleryImg"/>
    </div>
    <div class="btn-box" data-id="employee_list" id="look">
        <a class="btn" href="javascript:" id="showToast" data-id="police-company_list">查看从业人员列表</a>
    </div>
    <div>
        <div class="weui-mask" id="iosMask" style="display: none"></div>
        <div class="weui-actionsheet" id="iosActionsheet">
            <div class="weui-actionsheet__menu" id="choice-list"></div>
            <div class="weui-actionsheet__action">
                <div class="weui-actionsheet__cell" id="iosActionsheetCancel">取消</div>
            </div>
        </div>
    </div>
    <div>
        <div class="weui-mask" id="iosMasks" style="display: none"></div>
        <div class="weui-actionsheet" id="iosActionsheets">
            <div class="weui-actionsheet__menu weui-actionsheet__menu-height" id="choice-lists">
                <div class="weui-actionsheet__cell group-choice-name" data-group="0">普通</div>
                <div class="weui-actionsheet__cell group-choice-name" data-group="1">其他</div>
            </div>
            <div class="weui-actionsheet__action">
                <div class="weui-actionsheet__cell" id="iosActionsheetCancels">取消</div>
            </div>
        </div>
    </div>
    <div class="blank active" id="alert">
        <div class="td-style td-top">
            <div class="td-name">姓名</div>
            <input type='text' id="legal-person-name" placeholder="法人姓名"/>
        </div>
        <div class="td-style">
            <div class="td-name">手机号码</div>
            <input type='text' id="legal-phone"  placeholder="11位手机号码"/>
        </div>
        <div class="td-style">
            <div class="td-name">电话号码</div>
            <input type='text' id="legal-company-tel-num" placeholder="企业电话号码"/>
        </div>
        <div class="td-style">
            <div class="td-name">身份证号</div>
            <input type='text' id="IdCard" placeholder="法人身份证号码"/>
        </div>
    </div>
    <div class="page-alert active" id="alertbackground">
        <div class="btn-box" data-id="employee_list" >
            <a class="btn" href="javascript:" id="new-save" data-id="police-company_list">确定</a>
        </div>
    </div>
    <div class="blank active" id="alert-person">
        <div class="td-style td-top">
            <div class="td-name">姓名</div>
            <input type='text' id="linkName" placeholder="联系人姓名"/>
            <span class="star-red">*</span>
        </div>
        <div class="td-style">
            <div class="td-name">手机号码</div>
            <input type='text' id="linkPhone" placeholder="11位手机号码"/>
            <span class="star-red">*</span>
        </div>
        <div class="td-style" >
            <div class="td-name">微信号</div>
            <input type='text' id="WeXin" placeholder="微信账号"/>
        </div>
        <div class="td-style">
            <div class="td-name">邮箱</div>
            <input type='text' id="E-mail" placeholder="邮箱账号"/>
        </div>
        <div class="td-style" >
            <div class="td-name">职位</div>
            <input type='text'id="Work" placeholder="工作职位"/>
        </div>
        <div class="prompt active" id="prompt">*请输入必填项</div>
    </div>
    <div class="page-alert active" id="personbackground"></div>
    <div class="page-alert active" id="changeground"></div>
    <div class="btn-box active" data-id="employee_list" id="person-news-change-btn">
        <a class="btn" href="javascript:" id="news-save" data-id="police-company_list">确定</a>
    </div>
    <div class="btn-box active" data-id="employee_list" id="amend">
        <a class="btn" href="javascript:" id="amend-new" data-id="police-company_list">修改</a>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var $iosActionsheet = $('#iosActionsheet');
        var $iosMask = $('#iosMask');
        var $iosActionsheets = $('#iosActionsheets');
        var $iosMasks = $('#iosMasks');
        function hideActionSheet() {
            $iosActionsheet.removeClass('weui-actionsheet_toggle');
            $iosMask.fadeOut(200);
            $iosActionsheets.removeClass('weui-actionsheet_toggle');
            $iosMasks.fadeOut(200);
        }
        $iosMask.on('click', hideActionSheet);
        $iosMasks.on('click', hideActionSheet);
        $('#iosActionsheetCancel').on('click', hideActionSheet);
        $('#iosActionsheetCancels').on('click', hideActionSheet);
        $gallery = $("#gallery"),
        $galleryImg = $("#galleryImg")
        var cid =  $('#container').data('data-company-name-cid');
        $.ajax({
            type: "POST",
            url: "api/company/detail.json",
            data:{id:cid,userid:$('#userid').val()},
            success: function (data) {
                lists(data);
            },
            error: function (mes) {
                $('#error').css("display","block");
            }
        });
        function lists(data) {
            var address = data.company.address;
            address = address==null?'':address;
            var company = data.company.name;
            var police = data.company.police.name;
            company = company==null?'':company;
                var html =      '<div id="news-change">'+
                                '<div class="head-title">基本信息</div>'+
                                '<div class="none-flex cell-border cell-margin">'+
                                '<div class="weui-cell__hd"><label class="weui-label">企业名称</label></div>'+
                                '<div class="weui-cell__bd bd-right" id="company-name">'+
                                company+
                                '</div>'+
                                '</div>'+
                                '<div class="none-flex cell-border cell-margin">'+
                                '<div class="weui-cell__hd"><label class="weui-label">企业地址</label></div>'+
                                '<div class="weui-cell__bd bd-right place-top" id="company-place">'+
                                address+
                                '</div>'+
                                '</div>'+
                                '<div class="none-flex cell-border cell-margin">'+
                                '<div class="weui-cell__hd"><label class="weui-label">企业分类</label></div>'+
                                '<div class="weui-cell__bd bd-right" id="classify">'+
                                '饭店'+
                                '</div>'+
                                '</div>'+
                                '<div class="none-flex cell-border cell-margin head-title-border">'+
                                '<div class="weui-cell__hd"><label class="weui-label">企业组别</label></div>'+
                                '<div class="weui-cell__bd bd-right" id="group">'+
                                '普通'+
                                '</div>'+
                                '</div>'+
                                '<div class="head-title">法人</div>'+
                                '<div class="none-flex cell-border cell-margin head-title-border" id="legal-person">'+
                                '<div class="weui-cell__hd"><label class="weui-label" id="legal-name">法人</label></div>'+
                                '<div class="weui-cell__bd bd-right">'+
                                '<span id="mobile-num">手机号</span><span id="symbol">/</span><span id="tel-num">电话号</span>'+
                                '</div>'+
                                '</div>'+
                                '<div class="head-title">联系人</div>'+
                                '<div id="link-box">'
                                for(var i=0;i<data.users.length;i++){
                                    var index = i+1;
                                    html +=
                                    '<div class="none-flex cell-border cell-margin link-alert"  data-name="'+data.users[i].name+'" data-phone="'+data.users[i].mobile+'" >' +
                                    '<div class="weui-cell__hd"><label class="weui-label label-width" id="linkman">'+data.users[i].name+'</label></div>' +
                                    '<div class="weui-cell__bd bd-right label-phone" >' +
                                        data.users[i].mobile +
                                    '</div>' +
                                    '</div>'
                                }
                                html += '</div>';
            ;
                html += '</div>';
            $('.cells-ajax').append(html);
            $('.head-img').on("click", function(){
                $galleryImg.attr("src", this.getAttribute("src"));
                $gallery.fadeIn(100);
            });
            $gallery.on("click", function(){
                $gallery.fadeOut(100);
            });
            $('#change').bind('click',function(){
                $(this).hide();
                $('.link-alert').addClass('link-man');
                $('#look').html('<a class="btn" href="javascript:" id="save" data-id="">保存</a>');
                var txt = $('#company-name').text();
                var txt1= $('#company-place').text();
                $('#company-name').html('<input class="input-change" type="text" value="'+txt+'" id="input-change"/>');
                $('#company-place').html('<textarea class="input-change" type="text" id="textarea-place">'+txt1+'</textarea>');
                $('#input-change').focus();
                var changeval = $('#input-change').val();
                $('#input-change').val(changeval);
                //选择企业分类
                $('#classify').on('click',function(){
                    $('#choice-list').html('');
                    $.ajax({
                        type: "POST",
                        url: "api/companyType.json",
                        data:{userid:$('#userid').val()},
                        success: function (data) {
                            for(var i = 0;i<data.length;i++){
                                $('#choice-list').append('<div class="weui-actionsheet__cell type-choice-name" id='+data[i].id+'>'+data[i].name+'</div>');
                            }
                            $iosActionsheet.addClass('weui-actionsheet_toggle');
                            $iosMask.fadeIn(200);
                            $('.type-choice-name').on('click',function(){
                                $('#classify').html($(this).text());
                                var typeId = $(this).attr('id');
                                $('#container').data('data-add-typeId',typeId);
                                hideActionSheet();
                            });
                        },
                        error: function (mes) {
                            console.log("error");
                        }
                    });
                });
                $('#group').on('click',function(){
                    $iosActionsheets.addClass('weui-actionsheet_toggle');
                    $iosMasks.fadeIn(200);
                    $('.group-choice-name').on('click',function(){
                        $('#group').html($(this).text());
                        var groupId = $(this).data('group');
                        $('#container').data('data-add-groupId',groupId);
                        hideActionSheet();
                    });
                });
                //法人信息修改
                $('#legal-person').on('click',function(){
                    $('#alert,#alertbackground').fadeIn(100);
                    var legalPhone = $('#legal-phone').val();
                    var legalCompanyNum = $('#legal-company-tel-num').val();
                    var changeLegalname = $('#legal-name').text();
                    $('#legal-person-name').val(changeLegalname);
                    var changelegalPhone = $('#mobile-num').text();
                    $('#legal-phone').val(changelegalPhone);
                    var changelegalCompanyNum = $('#tel-num').text();
                    $('#legal-company-tel-num').val(changelegalCompanyNum);
                    $('#legal-person-name').focus();
                    if(legalPhone.length == 0||legalCompanyNum.length==0){
                        $('#symbol').show();
                    }
                    $('#new-save').on('click',function(){
                        $('#alert,#alertbackground').fadeOut(100);
                        var legalName = $('#legal-person-name').val();
                        $('#legal-name').html(legalName);
                        var legalPhone = $('#legal-phone').val();
                        $('#mobile-num').html(legalPhone);
                        var legalCompanyNum = $('#legal-company-tel-num').val();
                        $('#tel-num').html(legalCompanyNum);
                    });
                    $('#alertbackground').on('click',function(){
                        $('#alert,#alertbackground').fadeOut(100);
                    });
                });
                $('#news-change').after(
                        '<div class="add-line" id="add-linkman"><span class="add">+</span>新增联系人<img src="images/icon-go.jpg" class="lt-img"/></div>'
                );
                //添加修改联系人
                $('#add-linkman').on('click',function(){
                    $('#alert-person,#personbackground,#person-news-change-btn').fadeIn(100);
                    $('#linkName,#linkPhone,#WeXin,#E-mail,#Work').val('');
                    $('#prompt').hide();
                    $('#personbackground').on('click',function(){
                        $('#alert-person,#personbackground,#person-news-change-btn').fadeOut(100);
                    });
                });
                $('.link-man').live('click',function(){
                    $('#prompt').hide();
                    $('#alert-person,#changeground,#amend').fadeIn(100);
                    $('#changeground').on('click',function(){
                        $('#alert-person,#changeground,#amend').fadeOut(100);
                    });
                    var _this = $(this).find('.label-width');
                    var _this_phone = $(this).find('.label-phone');
                    $('#linkName').val(_this.text());
                    $('#linkPhone').val(_this_phone.text());
                    $('#amend-new').on('click',function(){
                        var linkmanName = $('#linkName').val();
                        var linkPhone = $('#linkPhone').val();
                        var WeXin = $('#WeXin').val();
                        var Email = $('#E-mail').val();
                        var Work = $('#Work').val();
                        if($('#linkName').val().length==0||$('#linkPhone').val().length==0){
                            $('#prompt').show();
                        }else{
                            _this.html($('#linkName').val());
                            _this_phone.html($('#linkPhone').val());
                            $('#alert-person,#changeground,#amend').fadeOut(100);
                        }
                    });
                });
                $('#save').on('click',function(){
                    $('#classify').unbind();
                    $('#group').unbind();
                    $('#legal-person').unbind();
                    $('#add-linkman').unbind();
                   $('#add-linkman').hide();
                    $('#change').show();
                    $('#look').html(' <a class="btn" href="javascript:" id="showToast" data-id="police-company_list">查看从业人员列表</a>');
                    $('#maskbox').hide();
                    var text = $('#input-change').val();
                    var text1 = $('#textarea-place').val();
                    $('#company-name').html(text);
                    $('#company-place').html(text1);
                    $('.link-alert').removeClass('link-man');
                    Toast();
                    var inputChange = $('#company-name').text();
                    var inputplace = $('#company-place').text();
                    var type = $('#container').data('data-add-typeId');
                    var group = $('#container').data('data-add-groupId');
                    var legalPersonName= $('#legal-person-name').val();
                    var legalPersonPhone= $('#legal-phone').val();
                    var legalPersonMobile= $('#legal-company-tel-num').val();
                    var legalPersonCard = $('#IdCard').val();
                    $('#form-box').html(
                            '<input name="name" value="'+inputChange+'"/>'+
                            '<input name="address" value="'+inputplace+'"/>'+
                            '<input name="type" value="'+type+'"/>'+
                            '<input name="groupType" value="'+group+'"/>'+
                            '<input name="legalPersonName" value="'+legalPersonName+'"/>'+
                            '<input name="legalPersonPhone" value="'+legalPersonPhone+'"/>'+
                            '<input name="legalPersonMobile" value="'+legalPersonMobile+'"/>'+
                            '<input name="legalPersonCard" value="'+legalPersonCard+'"/>'+
                            '<div id="add-list-name"></div>'
                    );
                    var linkLength = $('#link-box').find('.link-alert').length;
                    for(var i = 0;i<=linkLength-1;i++){
                        var manLink = $('#link-box').find('.link-alert').eq(i);
                        var name = manLink.data('name');
                        var phone = manLink.data('phone');
                        var WeXin = manLink.data('weixin');
                        var Email = manLink.data('email');
                        var Work = manLink.data('post');
                        $('#add-list-name').append(
                                '<input name="add['+i+'].name" value="'+name+'"/>'+
                                '<input name="add['+i+'].mobile" value="'+phone+'"/>'+
                                '<input name="add['+i+'].wid" value="'+WeXin+'"/>'+
                                '<input name="add['+i+'].email" value="'+Email+'"/>'+
                                '<input name="add['+i+'].post" value="'+Work+'"/>'
                        );
                    }
                    var json = $('#form-box').serialize();
                    console.log(json);
                    $.ajax({
                        type: "PUT",
                        url: "api/company/update.json",
                        data:json,
                        success: function () {
                            $('#notNull').hide();
                            var id = $('#showToast').data('id');
                            window.pageManager.go(id);
                        },
                        error: function () {
                        }
                    });
                });
            });
        }
        $('#news-save').on('click',function(){
            var linkmanName = $('#linkName').val();
            var linkPhone = $('#linkPhone').val();
            var WeXin = $('#WeXin').val();
            var Email = $('#E-mail').val();
            var Work = $('#Work').val();
            if(linkmanName.length==0||linkPhone.length==0){
                $('#prompt').show();
            }else{
                var html =  '<div class="none-flex cell-border cell-margin link-alert link-man" data-name="'+linkmanName+'" data-phone="'+linkPhone+'" data-weixin="'+WeXin+'" data-email="'+Email+'" data-post="'+Work+'">'+
                        '<div class="weui-cell__hd"><label class="weui-label label-width">'+linkmanName+'</label></div>'+
                        '<div class="weui-cell__bd bd-right label-phone">'+
                        linkPhone+
                        '</div>'+
                        '</div>'
                $('#link-box').append(html);
                $('#alert-person,#personbackground,#person-news-change-btn').fadeOut(100);
            }
        });
        function  Toast() {
            $('#showToast').on('click',function(){
                $('#container').data('data-list-employee-val',null);
                $('#container').data('data-company-name-cid',cid);
                var id = $('.btn-box').data('id');
                $('#taskId').val($(this).data('tid'));
                window.pageManager.go(id);
            })
        }
        Toast();
    })
</script>

</body>
</html>