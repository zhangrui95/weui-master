<!--旅店信息-->
<div class="page page_box">
    <div class="page__bd bg-page bottom-cell page-list">
        <div class="weui-tab">
            <div class="weui-navbar fixed">
                <div class="weui-navbar__item weui-bar__item_on" href="#tab1" data-state="0">未核查</div>
                <div class="weui-navbar__item" href="#tab2" data-state="1">已核查</div>
            </div>
        </div>
        <div class="height-fixed"></div>
            <div class="weui-tab__panel panel_none">
                <div class="weui-cells cell-y"  id="tab1"></div>
                <div class="weui-cells active cell-y"  id="tab2"></div>
            </div>
            <div class="weui-loadmore" id="load">
                <i class="weui-loading"></i>
                <span class="weui-loadmore__tips">正在加载</span>
            </div>
        <div class="weui-loadmore weui-loadmore_line active" id="new-none">
            <span class="weui-loadmore__tips">暂无更多数据</span>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        document.title = '列表';
        var gPageSize = 10;
        var offset = 0;
        var currState = '0';
        var loading = false;
        $('.weui-navbar__item').on('click', function () {
            $(this).addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
        });
        $(".weui-navbar div").click(function() {
            var state = $(this).data('state');
            if(state != currState){
                var activeTab = $(this).attr("href");
                $(".weui-cells").hide();
                $(activeTab).fadeIn();
                getData(state)
            }
            return false;
        });
        $('.weui-cell').on('click', function(){
            var id = $(this).data('id');
            window.pageManager.go(id);
        });

        function getData(state) {
            if(loading){
                return;
            }
            loading = true;
            if(state != currState){
                currState = state;
                offset = 0;
                var tabPanel = state=='0'?'tab1':'tab2';
                $('#'+tabPanel).html('');
            }
            $.ajax({
                type: "POST",
                url: "api/task/leader.json",
                async: true,
                data: {state:state,userid: $('#userid').val(), max: gPageSize, offset: offset},
                success: function (data) {
                    lists(data,state);
                    $("#load").hide();
                    loading = false;
                    if(data==null||data.length<1){
                        $('.weui-loadmore').css('display','none');
                    }
                },
                beforeSend: function () {
                    $("#load").show();
                },
                error: function () {
                    $("#load").hide();
                    loading = false;
                }
            });
        }
        function lists(data,state) {
            if(data==null||data.length<1){
                var tabPanel = state=='0'?'tab1':'tab2';
                tabPanel = $('#'+tabPanel);
                if(state=='0'){
                    tabPanel.append(
                            '<div class="empty-box">'+
                            '<img src="images/icon-ok.jpg" class="empty-img"/>'+
                            '<p class="null-word">好厉害！</p>'+
                            '<p class="null-word2">已经没有未核查的信息了</p>'+
                            '</div>'
                    );
                }else{
                    tabPanel.append(
                            '<div class="empty-box">'+
                            '<img src="images/icon-over.jpg" class="empty-img"/>'+
                            '<p class="null-word">哎呦喂！</p>'+
                            '<p class="null-word2">快去看看是否有未核查的信息</p>'+
                            '</div>'
                    );
                }
            }
            var dataId = 'detail';
            var tabPanel = state=='0'?'tab1':'tab2';
            tabPanel = $('#'+tabPanel);
            offset += data.length;
            for(var i=0;i<data.length;i++) {
                var items=data[i];
                tabPanel.append(
                        '<div class="weui-cell bg-cell"  data-id="'+dataId+'" data-tid="'+items.id+'">' +
                            '<div class="weui-cell__bd cell_bd_border" >' +
                                '<div><img src="images/list-left.jpg" class="border-right-img"/></div>'+
                                    '<p class="left-cell">' +
                                        items.user.company +
                                    '</p>' +
                                    '<div class="weui-cell__ft cell_fs left-cell">' +
                                    '<img src="images/icon-time.jpg" class="position-time"/>'+
                                    '<span>'+getLocalTime(items.createTime)+'</span>'  +
                                    '<img class="icon-go" src="images/icon-go.jpg"/>'+
                                '</div>' +
                            '</div>' +
                        '</div>'
                );
            }
            $('.weui-cell').bind('click', function () {
                var id = $(this).data('id');
                $('#taskId').val($(this).data('tid'));
                window.pageManager.go(id);
            });
        }

        getData(currState);

        var pagePanel = $('#container .page_box');
        //到达底部加载
        var winH = $('#container').height(); //页面可视区域高度
        var scrollHandler = function () {
            var pageH = pagePanel.find('.page__bd').height();
            var scrollT = pagePanel.scrollTop();
            var aa = (pageH - winH - scrollT) / winH;
            if (aa < 0.02) {
                getData(currState);
            }else if(aa==0){
                $('.weui-loadmore_line').show();
            }
        };
        //定义鼠标滚动事件
        pagePanel.on('scroll',scrollHandler);
    });

</script>


