<!--基本信息-->
<div class="page">
    <div class="page__bd">
        <div class="weui-cells weui-cells_form" style="margin-top: 0;">
            <div class="weui-cell">
                <div class="weui-cell__bd cell-unleft">
                    <div class="weui-uploader">
                        <div class="weui-uploader__bd">
                            <ul class="weui-uploader__files" id="uploaderFiles">
                            </ul>
                            <div class="weui-uploader__input-box file-img">
                                <input id="uploaderInput" class="weui-uploader__input" type="button" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="weui-cells">
            <div class="weui-cell border-cell">
                <div class="weui-cell__bd cell-unleft">
                    <input id="card" class="weui-input" type="text" placeholder="请输入旅客身份证号"/>
                </div>
                <span id="empty" class="active"><img src="./images/empty.png" class="empty"/></span>
            </div>
        </div>
        <div id="idCard" class="prompt"></div>
        <div class="weui-gallery" id="gallery">
            <span class="weui-gallery__img" id="galleryImg"></span>
            <div class="weui-gallery__opr">
                <a href="javascript:" class="weui-gallery__del">
                    <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="weui-btn-area">
        <a class="weui-btn weui-btn_primary" href="javascript:" id="showToast" >提交</a>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var tmpl = '<li class="weui-uploader__file file-li-img" style="background-image:url(#url#)"></li>',
                $gallery = $("#gallery"), $galleryImg = $("#galleryImg"),
                $uploaderInput = $("#uploaderInput"),
                $uploaderFiles = $("#uploaderFiles"),
                localId
                ;
        $uploaderInput.on("click", function(e){
            wx.chooseImage({
                count: 1, // 默认9
                sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                success: function (res) {
                    var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                    localId = localIds[0];
                    $uploaderFiles.append($(tmpl.replace('#url#', localId)));
                    $(".weui-uploader__input-box").css("display","none");
                    $('.weui-gallery__opr').click(function () {
                        $uploaderFiles.html('');
                        localId = '';
                        $(".weui-uploader__input-box").css("display","block");
                    })
                },
                fail:function(err){
                    $('#idCard').html("选择照片失败！");
                }
            });
        });
        $uploaderFiles.on("click", "li", function(){
            $galleryImg.attr("style", this.getAttribute("style"));
            $gallery.fadeIn(100);
        });
        $gallery.on("click", function(){
            $gallery.fadeOut(100);
        });
        $('#card').blur(function () {
            var value=$('#card').val();
            var filter = /^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/;
                if (!filter.test(value)) {
                    if (value == '') {
                        $('#idCard').html("*身份证号码不能为空");
                    } else {
                        $('#idCard').html("*无效的身份证号码");
                        $('#empty').css('display', 'block');
                    }
                }
        });
        $('#card').focus(function(){
            $('#idCard').html("");
        });
        $('#card').keyup(function(){
            if(($('#card').val()+"").length>=1){
                $('#empty').css('display', 'block');
                $('#empty').click(function () {
                    $('#card').val('');
                    $('#empty').css('display', 'none');
                    $('#idCard').html("");
                })
            }else {
                $('#empty').css('display', 'none');
            }
        });
        $('#showToast').on('click',function(){
            if(localId==null||localId==''){
                $('#idCard').html("*照片不能为空");
                return;
            }
            var value=$('#card').val();
            var filter = /^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/;
            if (!filter.test(value)){
                if(value==''){
                    $('#idCard').html("*身份证号码不能为空");
                }else{
                    $('#idCard').html("*无效的身份证号码");
                    $('#empty').css('display','block');
                    $('#empty').click(function () {
                        $('#card').val('');
                        $('#empty').css('display','none');
                        $('#idCard').html("");
                    })
                }
                return;
            }
            wx.uploadImage({
                localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
                isShowProgressTips: 1,// 默认为1，显示进度提示
                success: function (res) {
                    var serverId = res.serverId; // 返回图片的服务器端ID
                    idCard(value,serverId);
                },
                fail:function(err){
                    $('#idCard').html("上传照片失败！");
                }
            });
        });
        function idCard(value,serverId){
            $('#idCard').html("");
            $('#empty').css('display','none');
            $.ajax({
                type: "POST",
                url: "api/task/save.json",
                async: true,
                data:{card:value,userid:$('#userid').val(),serverId:serverId},
                success: function (card) {
                },
                error: function () {
                }
            });
        }
    });
</script>
