<div class="page page-rent">
    <div class="head-title">出租屋信息</div>
    <div class="none-flex cell-border cell-margin">
        <div class="weui-cell__hd"><label class="weui-label name-width">地址</label></div>
        <div class="weui-cell__bd bd-right font-color" id="company-name">
            <input type="text" class="address-input"/>街<span class="red">*</span><input type="text" class="address-input"/>号<span class="red">*</span></br>
            <input type="text" class="address-input-width"/>栋<input type="text" class="address-input-width"/>单元<span class="red">*</span><input type="text" class="address-input-width"/>门<span class="red">*</span>
        </div>
    </div>
    <div class="none-flex cell-border cell-margin cell-img-padding">
        <div class="weui-cell__hd"><label class="weui-label img-height-box">单元</label></div>
        <div class="weui-cell__bd bd-right font-color place-top" id="element">
            <div class="weui-uploader__bd">
                <ul class="weui-uploader__files" id="elementFiles"></ul>
                <div class="weui-uploader__input-box input-box">
                    <input id="elementInput" class="weui-uploader__input" type="button">
                    <img src="images/photo.png" class="rent-add-camera">
                </div>
            </div>
        </div>
    </div>
    <div class="none-flex cell-border cell-margin cell-img-padding">
        <div class="weui-cell__hd"><label class="weui-label img-height-box">门牌</label></div>
        <div class="weui-cell__bd bd-right font-color place-top" id="doorplate">
            <div class="weui-uploader__bd">
                <ul class="weui-uploader__files" id="doorplatePerson"></ul>
                <div class="weui-uploader__input-box input-box">
                    <input id="doorplateInput" class="weui-uploader__input" type="button">
                    <img src="images/photo.png" class="rent-add-camera">
                </div>
            </div>
        </div>
    </div>
    <div class="none-flex cell-border cell-margin">
        <div class="weui-cell__hd"><label class="weui-label">社区</label></div>
        <div class="weui-cell__bd bd-right font-color blur" id="community">请选择</div>
        <div class="red-star">*</div>
    </div>
    <div class="none-flex cell-border cell-margin">
        <div class="weui-cell__hd"><label class="weui-label">楼长</label></div>
        <div class="weui-cell__bd bd-right font-color blur" id="residence-advisor">请选择</div>
        <div class="red-star">*</div>
    </div>
    <div class="btn-box" data-id="employee_list" id="look">
        <div class="btn-box button-box" id="btnPanel">
            <a class="btn" href="javascript:" id="next-step">下一步</a>
        </div>
    </div>
    <div class="active renter-news" id="renter-news">
        <div class="head-title">租住人员信息</div>
        <div id="idCard-list"></div>
        <div class="add-line" id="add-renter"><span class="add">+</span>新增租住人员信息</div>
        <div class="btn-box" data-id="employee_list" id="">
            <div class="btn-box button-box">
                <div class="imported-left none-style" id="last-step">上一步</div>
                <a class="btn-bg bg-style" href="javascript:" id="save" data-id="rent">保存</a>
            </div>
        </div>
    </div>
    <div class="page-alert active" id="personbackground">
        <div class="page__bd">
            <div class="weui-cells weui-cells_form" style="margin-top: 0;">
                <div class="weui-cell">
                    <div class="weui-cell__bd cell-unleft">
                        <div class="weui-uploader">
                            <div class="weui-uploader__bd">
                                <ul class="weui-uploader__files" id="uploaderFiles">
                                </ul>
                                <div class="weui-uploader__input-box file-img">
                                    <input id="uploaderInput" class="weui-uploader__input" type="button" />
                                    <p class="change-img">选择旅客照片</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="weui-cells">
                <div class="weui-cell border-cell padding-cell">
                    <div class="weui-cell__bd cell-unleft">
                        <input id="card" class="weui-input input-margin" type="text" placeholder="旅客身份证号"/>
                    </div>
                    <span id="empty" class="active"><img src="images/empty.png" class="empty"/></span>
                </div>
            </div>
            <div class="prompt active" id="idCard" style="opacity: 0; display: none;"></div>
            <div class="weui-gallery" id="gallery">
                <span class="weui-gallery__img" id="galleryImg"></span>
                <div class="weui-gallery__opr">
                    <a href="javascript:" class="weui-gallery__del">
                        <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="button-box button-style">
            <a class="imported-left none-style" href="javascript:" id="dis-none2" data-id="">取消</a>
            <a class="btn-bg bg-style" href="javascript:" id="submit-img" data-id="">提交</a>
        </div>
    </div>
    <div class="js_dialog" id="androidDialog2" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog weui-skin_android">
            <div class="weui-dialog__bd" id="dialog"></div>
            <div class="weui-dialog__ft" id="primary-box">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default" id="default">取消</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="primary">确定</a>
            </div>
        </div>
    </div>
    <div>
        <div class="weui-mask" id="iosMask" style="display: none"></div>
        <div class="weui-actionsheet" id="iosActionsheet">
            <div class="weui-actionsheet__menu" id="choice-list"></div>
            <div class="weui-actionsheet__action">
                <div class="weui-actionsheet__cell" id="iosActionsheetCancel">取消</div>
            </div>
        </div>
    </div>
    <div>
        <div class="weui-mask" id="iosMasks" style="display: none"></div>
        <div class="weui-actionsheet" id="iosActionsheets">
            <div class="weui-actionsheet__menu" id="choice-lists"></div>
            <div class="weui-actionsheet__action">
                <div class="weui-actionsheet__cell" id="iosActionsheetCancels">取消</div>
            </div>
        </div>
    </div>
</div>
<script>
    $(function(){
        var $iosActionsheet = $('#iosActionsheet');
        var $iosMask = $('#iosMask');
        var $iosActionsheets = $('#iosActionsheets');
        var $iosMasks = $('#iosMasks');
        function hideActionSheet() {
            $iosActionsheet.removeClass('weui-actionsheet_toggle');
            $iosMask.fadeOut(200);
            $iosActionsheets.removeClass('weui-actionsheet_toggle');
            $iosMasks.fadeOut(200);
        }
        $iosMask.on('click', hideActionSheet);
        $iosMasks.on('click', hideActionSheet);
        $('#iosActionsheetCancel').on('click', hideActionSheet);
        $('#iosActionsheetCancels').on('click', hideActionSheet);
        //选择社区
        $('#community').on('click',function(){
            $('#choice-list').html('');
            $.ajax({
                type: "POST",
                url: "api/community.json",
                data:{userid:$('#userid').val()},
                success: function (data) {
                    for(var i = 0;i<data.length;i++){
                        $('#choice-list').append('<div class="weui-actionsheet__cell type-choice-name" id='+data[i].id+'>'+data[i].name+'</div>');
                    }
                    $iosActionsheet.addClass('weui-actionsheet_toggle');
                    $iosMask.fadeIn(200);
                    $('.type-choice-name').on('click',function(){
                        $('#community').html($(this).text());
                        var communityId = $(this).attr('id');
                        $('#container').data('data-add-typeId',communityId);
                        hideActionSheet();
                    });
                },
                error: function (mes) {
                    console.log("error");
                }
            });
        });
        //选择楼长
        $.ajax({
            type: "POST",
            url: "api/user/policeHadArea.json",
            data: {userid: $('#userid').val()},
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    $('#choice-lists').append('<div class="weui-actionsheet__cell police-choice-name" id=' + data[i].id + '>' + data[i].name + '</div>');
                }
            },
            error: function () {
                console.log("error");
            }
        });
        $('#residence-advisor').on('click',function(){
            $iosActionsheets.addClass('weui-actionsheet_toggle');
            $iosMasks.fadeIn(200);
            $('.police-choice-name').on('click', function () {
                $('#residence-advisor').html($(this).text());
                var residenceAdvisorId = $(this).attr('id');
                $('#container').data('data-add-policeId', residenceAdvisorId);
                hideActionSheet();
            });
        });
        //下一步
        $('#next-step').on('click',function(){
            inPop(function(){
                $('#renter-news').hide();
            });
            $('#renter-news').show();
            $('#idCard-list').html('');
        });
        $('#last-step').click(function(){
            $('#renter-news').hide();
        });
        $('#add-renter').click(function(){
            inPop(function(){
                $('#personbackground').hide();
            });
            $('#card').val('');
            $('#personbackground').show();
        });
        $('#dis-none2').click(function(){
            outPop();
            $('#personbackground').hide();
        });
        function inPop(callback){
            pageManager.setBeforeHashchangeOnce(function (e) {
                callback();
                return false;
            })
        }
        function outPop(){
            pageManager.setBeforeHashchangeOnce(null)
        }
        //上传租住人员信息
        var tmpl = '<li class="weui-uploader__file head-image" style="background-image:url(#url#)"></li>',
                $gallery = $("#gallery"), $galleryImg = $("#galleryImg"),
                $uploaderInput = $("#uploaderInput"),
                $uploaderFiles = $("#uploaderFiles"),
                $elementInput = $('#elementInput'),
                $elementFiles = $('#elementFiles'),
                localId,
                tag = false
                ;
        $uploaderInput.on("click", function(e){
            wx.chooseImage({
                count: 1, // 默认9
                sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                success: function (res) {
                    var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                    localId = localIds[0];
                    $uploaderFiles.append($(tmpl.replace('#url#', localId)));
                    $(".weui-uploader__input-box").css("display","none");
                    $('.weui-gallery__opr').click(function () {
                        $uploaderFiles.html('');
                        localId = '';
                        $(".weui-uploader__input-box").css("display","block");
                    })
                },
                fail:function(err){
                    $('#idCard').html("选择照片失败！");
                    $('#idCard').fadeIn(100);
                    setTimeout(function () {
                        $('#idCard').fadeOut(100);
                    }, 2000);
                }
            });
        });
        $uploaderFiles.on("click", "li", function(){
            inPop(function(){
                $gallery.fadeOut(100);
            });
            $galleryImg.attr("style", this.getAttribute("style"));
            $gallery.fadeIn(100);
        });
        $gallery.on("click", function(){
            outPop();
            $gallery.fadeOut(100);
        });
        var cardValid = function (value) {
            var ex = /^((1[1-5])|(2[1-3])|(3[1-7])|(4[1-6])|(5[0-4])|(6[1-5])|71|(8[12])|91)\d{4}(19|2[0-9])((\d{2}(0[13-9]|1[012])(0[1-9]|[12]\d|30))|(\d{2}(0[13578]|1[02])31)|(\d{2}02(0[1-9]|1\d|2[0-8]))|(([13579][26]|[2468][048]|0[48])0229))\d{3}(\d|X|x)?$/;
            var pattern = new RegExp(ex);
            if(!pattern.test(value)){
                return false;
            }
            var params = [ 7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2 ];
            var checks = [ 1, 0, 10, 9, 8, 7, 6, 5, 4, 3, 2 ];
            var id=value;
            var sum = 0;
            for (var i = 0; i < 17; i++) {
                var tmp = id.charAt(i);
                sum += params[i] * tmp;
            }
            sum %= 11;
            var check;
            if (id.charAt(17) == 'x' || id.charAt(17) == 'X') {
                check = 10;
            } else {
                check = id.charAt(17);
            }
            return check == checks[sum];
        };
        $('#card').blur(function () {
            $('#empty').css('display', 'none');
            var value=$('#card').val();
            if (value == '') {
                $('#idCard').html("身份证号码不能为空");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
            } else if(!cardValid(value)){
                $('#idCard').html("无效的身份证号码");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
                $('#empty').css('display', 'block');
                return ;
            }
        });
        $('#card').keyup(function(){
            if(($('#card').val()+"").length>=1){
                $('#empty').css('display', 'block');
                $('#empty').click(function () {
                    $('#card').val('');
                    $('#empty').css('display', 'none');
                })
            }else {
                $('#empty').css('display', 'none');
            }
        });
        $('#submit-img').on('click',function(){
//            if(localId==null||localId==''){
//                $('#idCard').html("照片不能为空");
//                $('#idCard').fadeIn(100);
//                setTimeout(function () {
//                    $('#idCard').fadeOut(100);
//                }, 2000);
//                return;
//            }
            var value=$('#card').val();
            if (value == '') {
                $('#idCard').html("身份证号码不能为空");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
                return ;
            }else if(!cardValid(value)){
                $('#idCard').html("无效的身份证号码");
                $('#idCard').fadeIn(100);
                setTimeout(function () {
                    $('#idCard').fadeOut(100);
                }, 2000);
                $('#empty').css('display', 'block');
                return ;
            }else{
                $('#idCard-list').append(
                        '<div class="none-flex cell-border cell-margin">'+
                        '<div class="weui-cell__hd card-val" data-img="'+localId+'">'+value+'</div>'+
                        '<div class="link-delete block dele-word">删除</div>'+
                        '</div>'
                );
                $('#personbackground').fadeOut(100);
                $('.dele-word').on('click',function(){
                    var _this = $(this);
                    $('#androidDialog2').fadeIn(100);
                    $('#dialog').html('确定删除该租住人员信息？');
                    $('#default').on('click',function(){
                        $('#androidDialog2').fadeOut(100);
                    });
                    $('#primary').on('click',function(){
                        $('#androidDialog2').fadeOut(100);
                        _this.parent().remove();
                    });
                });
            }
            if(tag){
                return;
            }
            tag = true;
            $('#card').blur();
        });
        //保存
        $('#save').click(function(){
            outPop();
            var id = $(this).data('id');
            window.pageManager.go(id);
        });
    });

</script>