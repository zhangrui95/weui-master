<div class="page">
    <div id="error" class="error" style="display: none;">
        <img src="images/error.png"/>
        <span>当前网络不可用，请检查你的网络设置</span>
    </div>
    <div class="fire-nochecked">
        <div class="nochecked-header" id="head-name"></div>
    </div>
    <div class="nochecked-y">
        <div class="fire-nocheck-title">检查现场</div>
        <div class="none-flex cell-border cell-margin">
            <div class="weui-cell__bd bd-right" >
                <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files" id="uploaderFiles"></ul>
                    <div class="weui-uploader__input-box">
                        <input id="uploaderInput" class="weui-uploader__input" type="button"/>
                        <img src="images/photo.png" class="photo" />
                    </div>
                </div>
            </div>
        </div>
        <div class="fire-nocheck-title">法律文书</div>
        <div class="none-flex cell-border cell-margin">
            <div class="weui-cell__bd bd-right" >
                <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files" id="uploaderBooks"></ul>
                    <div class="weui-uploader__input-box">
                        <input id="inputBooks" class="weui-uploader__input" type="button" />
                        <img src="images/photo.png" class="photo" />
                    </div>
                </div>
            </div>
        </div>
        <div class="fire-nocheck-title">消防负责人</div>
        <div class="none-flex cell-border cell-margin">
            <div class="weui-cell__bd bd-right" >
                <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files" id="uploaderPerson"></ul>
                    <div class="weui-uploader__input-box">
                        <input id="inputPerson" class="weui-uploader__input" type="button" />
                        <img src="images/photo.png" class="photo" />
                    </div>
                </div>
            </div>
        </div>
        <div id="img-null" class="prompt"></div>
        <div class="weui-gallery" id="gallery">
            <span class="weui-gallery__img" id="galleryImg"></span>
            <div class="weui-gallery__opr">
                <a href="javascript:" class="weui-gallery__del">
                    <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="btn-box" id="btnPanel">
        <a class="btn box-orange" href="javascript:" id="showToast" >提交</a>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var cid =  $('#container').data('data-company-name-cid');
        var tmpl = '<li class="weui-uploader__file check-img" style="background-image:url(#url#)" data-media-id="#mid#"></li>',
                $gallery = $("#gallery"), $galleryImg = $("#galleryImg"),
                $uploaderInput = $("#uploaderInput"),
                $inputBooks = $('#inputBooks'),
                $inputPerson = $("#inputPerson"),
                $uploaderFiles = $("#uploaderFiles"),
                $uploaderBooks = $('#uploaderBooks'),
                $uploaderPerson = $("#uploaderPerson")
                ;

        $.ajax({
            type: "POST",
            url: "api/company/detail.json",
            data:{userid:$('#userid').val(),cid:cid},
            success: function (data) {
                $('#head-name').html(data.name);
            },
            error: function (mes) {
                console.log("error");
            }
        });

        var choose = function (localCb) {
            wx.chooseImage({
                count: 1, // 默认9
                sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                sourceType: ['camera'], // 可以指定来源是相册还是相机，默认二者都有
                success: function (res) {
                    var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                    var localId = localIds[0];
                    localCb(localId);
                },
                fail:function(err){
                    $('#img-null').html("选择照片失败！");
                }
            });
        };

        var upload = function (localId,serverCb) {
            wx.uploadImage({
                localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
                isShowProgressTips: 1,// 默认为1，显示进度提示
                success: function (res) {
                    var serverId = res.serverId; // 返回图片的服务器端ID
                    serverCb(localId,serverId);
                },
                fail:function(err){
                    $('#error').css("display","block");
                }
            });
        };

        var addItem = function(imgList) {
            choose(function(localId){
                upload(localId,function(serverId){
                    $('#img-null').html("");
                    imgList.append($(tmpl.replace('#url#', localId).replace('#mid#',serverId)));
                });
            });
        };

        $uploaderInput.on("click", function(e){
            addItem($uploaderFiles);
        });
        $inputBooks.on("click", function(e){
            addItem($uploaderBooks);
        });
        $inputPerson.on("click", function(e){
            addItem($uploaderPerson);
        });
        $uploaderFiles.on("click", "li", function(){
            $galleryImg.attr("style", this.getAttribute("style"));
            $('.weui-gallery__opr').data('curr-media-id',$(this).data('media-id'));
            $gallery.fadeIn(100);
        });
        $gallery.on("click", function(){
            $('.weui-gallery__opr').data('curr-media-id',null);
            $gallery.fadeOut(100);
        });
        $('.weui-gallery__opr').click(function () {
            var curr = $(this).data('curr-media-id');
            $uploaderFiles.find('[data-media-id="'+curr+'"]').remove();
            $uploaderBooks.find('[data-media-id="'+curr+'"]').remove();
            $uploaderPerson.find('[data-media-id="'+curr+'"]').remove();
        });
        function addImg(checkIds,legalIds,fireIds){
            $('#img-null').html("");
            $('#empty').css('display','none');
            $.ajax({
                type: "POST",
                url: " api/fireCheck/save.json",
                async: true,
                data:{userid:$('#userid').val(),checkIds:checkIds,legalIds:legalIds,fireIds:fireIds},
                success: function (card) {
                    wx.closeWindow();
                },
                error: function () {
                    $('#error').css("display","block");
                }
            });
        }

        var getMids = function (lis) {
            var ids = [];
            lis.each (function(){
                ids.push($(this).data('media-id'));
            });
            return ids.join(',');
        };

        $('#showToast').on('click',function(){
            var checkLis = $uploaderFiles.find('li'),
                legalLis = $uploaderBooks.find('li'),
                fireLis = $uploaderPerson.find('li');
            if(checkLis.length == 0 || legalLis.length == 0 || fireLis.length == 0 ){
                $('#img-null').html("照片不能为空");
                return;
            }
            addImg(getMids(checkLis),getMids(legalLis),getMids(fireLis));
        })
    });
</script>