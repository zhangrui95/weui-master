<!--旅店信息-->
<div class="page">
    <div class="page__bd bg-page">
        <div class="weui-tab">
            <div class="weui-navbar fixed">
                <div class="weui-navbar__item weui-bar__item_on" href="#tab1" data-state="0">未完成</div>
                <div class="weui-navbar__item" href="#tab2" data-state="1">已完成</div>
            </div>
            <div class="weui-tab__panel">
                <div class="weui-cells"  id="tab1"></div>
                <div class="weui-cells active"  id="tab2"></div>
            </div>
            <div class="weui-loadmore">
                <i class="weui-loading"></i>
                <span class="weui-loadmore__tips">正在加载</span>
            </div>
            <!--<div class="weui-loadmore weui-loadmore_line">-->
                <!--<span class="weui-loadmore__tips">暂无数据</span>-->
            <!--</div>-->
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var gPageSize = 10;
        var pagenumber = 1;
        var currState = '0';
        $('.weui-navbar__item').on('click', function () {
            $(this).addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
        });
        $(".weui-navbar div").click(function() {
            var state = $(this).data('state');
            if(state != currState){
                var activeTab = $(this).attr("href");
                $(".weui-cells").hide();
                $(activeTab).fadeIn();
                getData(state)
            }
            return false;
        });
        $('.weui-cell').on('click', function(){
            var id = $(this).data('id');
            window.pageManager.go(id);
        });

        function getData(state) {
            if(state != currState){
                currState = state;
                pagenumber = 1;
                var tabPanel = state=='0'?'tab1':'tab2';
                $('#'+tabPanel).html('');
            }
            $.ajax({
                type: "POST",
                url: "api/task.json",
                async: true,
                data: {state:state,userid: $('#userid').val(), max: gPageSize, offset: (pagenumber-1)*gPageSize},
                success: function (data) {
                    lists(data,state);
                    pagenumber++;
                },
                beforeSend: function () {
                    $(".weui-loadmore").show();
                },
                error: function () {
                    $(".weui-loadmore").hide();
                }
            });
        }
        function lists(data,state) {
            var dataId = state=='0'?'Unfinished_detail':'Finished_detail';
            var tabPanel = state=='0'?'tab1':'tab2';
            tabPanel = $('#'+tabPanel);
            for(var i=0;i<data.length;i++) {
                var items=data[i];
                tabPanel.append(
                        '<div class="weui-cell bg-cell"  data-id="'+dataId+'" data-tid="'+items.id+'">' +
                            '<div class="weui-cell__bd cell_bd_border" >' +
                                '<p class="left-cell">' +
                                    items.hotelName +
                                '</p>' +
                                '<div class="weui-cell__ft cell_fs left-cell">' +
                                    getLocalTime(items.createTime) +
                                '</div>' +
                            '</div>' +
                        '</div>'
                );
            }
            $('.weui-cell').bind('click', function () {
                var id = $(this).data('id');
                $('#taskId').val($(this).data('tid'));
                window.pageManager.go(id);
            });
        }
        getData(currState);
        //到达底部加载
        var winH = $(window).height(); //页面可视区域高度
        console.log(winH);
        var scrollHandler = function () {
            var pageH = $(document.body).height();
            var scrollT = $(window).scrollTop();
            var aa = (pageH - winH - scrollT) / winH;
            console.log(aa)
            if (aa < 0.02) {
                if (i % 10 === 0) {//每10页做一次停顿！
                    getData();
                    $(".weui-loadmore").show();
                } else {
                    getData();
                    $(".weui-loadmore").hide();
                }
            }

        }
        //定义鼠标滚动事件
        $(window).scroll(scrollHandler);
    });

</script>


