<div class="page page-list">
    <div id="error" class="error" style="display: none;">
        <img src="images/error.png"/>
        <span>当前网络不可用，请检查你的网络设置</span>
    </div>
    <div class="page__bd details cells-ajax page_y"></div>
    <div class="btn-box" id="btnPanel" style="display: none">
        <a class="btn" href="javascript:" id="showToast" >核查完毕</a>
    </div>
    <div class="weui-gallery" id="gallery">
        <img  class="weui-gallery__img center-img" id="galleryImg"/>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        $gallery = $("#gallery"),
        $galleryImg = $("#galleryImg")
        $.ajax({
            type: "POST",
            url: "api/task/leaderDetail.json",
            data:{id:$('#taskId').val(),userid:$('#userid').val()},
            success: function (data) {
                lists(data);
                if($('#btnPanel').css('display','none')){
                    $('.page_y').css('height','100%');
                }
            },
            error: function (mes) {
                $('#error').css("display","block");
            }
        });
        function lists(data) {
            var task = data.task;
            var rota = data.rota;
            if(rota != null && rota.length > 0){
                rota = rota[0].user.uid;
            }
                var html ='<div class="weui-cells weui-cells_form" id="'+task.id+'">' +
                           '<div class="weui-cell cell-top">'+
                                '<div class="weui-cell__bd bd-center cell-unleft">'+
                                    '<img src="api/task/photo?id='+task.id+'&userid='+$('#userid').val()+'" alt="" class="head-img">'+
                               '</div>'+
                            '</div>'+
                            '<div class="weui-cell cell-border">'+
                                '<div class="weui-cell__hd"><label class="weui-label">身份证号</label></div>'+
                                '<div class="weui-cell__bd bd-right">'+
                                    task.card+
                                '</div>'+
                            '</div>'+
                            '<div class="weui-cell cell-border cell-margin">'+
                                '<div class="weui-cell__hd"><label class="weui-label">入住宾馆</label></div>'+
                                '<div class="weui-cell__bd bd-right" >'+
                                    task.user.company+
                                '</div>'+
                            '</div>'+
                            '<div class="weui-cell cell-border cell-margin">'+
                                '<div class="weui-cell__hd"><label class="weui-label">宾馆地址</label></div>'+
                                '<div class="weui-cell__bd bd-right" >'+
                                    task.user.address+
                                '</div>'+
                            '</div>'+
                            '<div class="weui-cell cell-border cell-margin">'+
                                '<div class="weui-cell__hd"><label class="weui-label">上报电话</label></div>'+
                                '<div class="weui-cell__bd bd-right" >'+
                                    task.user.mobile+
                                '</div>'+
                            '</div>'+
                            '<div class="weui-cell cell-border">'+
                                '<div class="weui-cell__hd"><label class="weui-label">上报时间</label></div>'+
                                '<div class="weui-cell__bd bd-right">'+
                                    getLocalTime(task.createTime)+
                                '</div>'+
                            '</div>'
                        ;
            if(task.state=='0'){
                if(rota == $('#userid').val()){
                    $('#btnPanel').show();
                    $('.page_y').css('height','88%');
                }
            }else{
                $('.page_y').css('height','95%');
                html+='<div class="weui-cell cell-border">'+
                        '<div class="weui-cell__hd"><label class="weui-label">完成时间</label></div>'+
                         '<div class="weui-cell__bd bd-right">'+
                            getLocalTime(task.doneTime)+
                        '</div>'+
                    '</div>'
            }
            html += '</div>';
            $('.cells-ajax').append(html);
            $('.head-img').on("click", function(){
            $galleryImg.attr("src", this.getAttribute("src"));
                $gallery.fadeIn(100);
            });
            $gallery.on("click", function(){
                $gallery.fadeOut(100);
            });
        }
        $('#showToast').click(function(){
            $.ajax({
                type: "POST",
                url: "api/task/doneTask.json",
                data:{id:$('#taskId').val(),userid:$('#userid').val()},
                success: function () {
                    var source = $('#container').data('detail-source');
                    if(source == null|| source == ''){
                        wx.closeWindow();
                    }else{
                        window.pageManager.go(source);
                    }
                },
                error: function (mes) {
                    $('#error').css("display","block");
                }
            });
        });
    })
</script>
