<div class="page">
    <div class="weui-grids">
        <div>列表：<select id="listRole" name="role">
            <option value="dept_dev">开发者</option>
            <option value="dept_dev">所领导</option>
            <option value="dept_dev">民警</option>
        </select></div>
        <ul id="list" ></ul>
    </div>
    <div style="margin-top: 10px">
        添加：
        <ul id="add" >
            <li>名称：<input type="text" name="name"/></li>
            <li>手机：<input type="text" name="mobile"/></li>
            <li>角色：<select id="addRole" name="role">
                <option value="dept_dev">开发者</option>
                <option value="dept_leader">所领导</option>
                <option value="dept_police">民警</option>
            </select></li>
            <li>职务：<select id="addPost" name="post"></select></li>
            <li><button id="add-save">添加</button></li>
        </ul>
    </div>
    <div id="result"></div>
</div>
<script>
    $(function(){

        var baseAction = {
            method:'POST',
            url:undefined,
            done:function (xhr) {
                $('#result').html(JSON.stringify(xhr));
                actions.list && actions.list.doAction({userid:$('#userid').val(),role:$('#listRole').val()});
            },
            fail:function (err) {
                $('#result').html(JSON.stringify(err));
            },
            doAction : function (data) {
                var remote = {
                    type: this.method,
                    url: this.url,
                    success: this.done,
                    error: this.fail
                };
                if(this.method == 'POST'){
                    remote.data = data;
                }else{
                    remote.url += '?'+data;
                }
                $.ajax(remote);
            }
        };

        var actions = {};
        var initAction = function (action) {
            var obj;
            if(typeof action == 'string'){
                obj = $.extend({url:action},baseAction);
            }else if(typeof action == 'object'){
                obj = $.extend({},baseAction,action);
            }else{
                return;
            }
            return obj;
        };

        var initActions = function (option) {
            for(var i in option){
                actions[i] = initAction(option[i])
            }
        };

        var option = {
            add:'api/user/save.json',
            update:'api/user/update.json',
            close:'api/user/close.json',
            delete:{
                method: "DELETE",
                url:'api/user/delete.json'
            },
            list:{
                url:'api/user/list.json',
                done:function (xhr) {
                    var html = '',item;
                    for(var i in xhr){
                        item = xhr[i];
                        html += '<li data-domain-id="'+item.id+'">' +
                                '<input type="text" name="name" value="'+item.name+'"/> -> ' + item.role+','+ item.state+
                        '<button style="margin: 0 5px 0 5px" data-action="save">修改</button><button data-action="del">删除</button></li>'
                    }
                    var $list = $('#list');
                    $list.html(html);
                    $list.find('[data-action="save"]').on('click',update);
                    $list.find('[data-action="del"]').on('click',del);
                }
            }
        };
        initActions(option);

        var add = function () {
            var $add = $('#add');
            actions.add.doAction({userid:$('#userid').val(),
                name:$add.find('[name="name"]').val(),
                mobile:$add.find('[name="mobile"]').val(),
                role:$add.find('[name="role"]').val(),
                post:$add.find('[name="post"]').val()
            });
        };

        var update = function () {
            var li = $(this).parent();
            actions.update.doAction({userid:$('#userid').val(),id:li.attr('data-domain-id'),name:li.find('[name="name"]').val()});
        };

        var del = function () {
            var li = $(this).parent();
            actions.delete.doAction('id='+li.attr('data-domain-id')+'&userid='+$('#userid').val());
        };

        var list = function (role) {
            actions.list.doAction({userid:$('#userid').val(),role:role});
        };

        var $listRole = $('#listRole');
        list($listRole.val());

        $listRole.on('change',function(){
            list($(this).val());
        });

        $('#addRole').on('change',function(){
            var role = $(this).val();
            var html = '';
            if(role == 'dept_leader'){
                html = '<option>所长</option><option>副所长</option><option>教导员</option>';
            }else if(role == 'dept_police'){
                html = '<option>民警</option><option>值班管理员</option><option>企业管理员</option>';
            }
            $('#addPost').html(html)
        });

        $('#add-save').on('click',add);

    });
</script>